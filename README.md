## 0. 改訂履歴

| 版 | 日付 | 作成者 | 概要 |
| --- | --- | --- | --- |
| 0.1 | 2025‑07‑15 | AI draft | 初版ドラフト作成 |

---

## 1. 目的 / Scope

バイオリンの弓運び（運弓）における弓と弦の接触力を数値化・可視化し、学習者が理想的な運弓を習得するためのフィードバックをリアルタイムに提供する装置の設計を行う。

## 2. 背景・課題

- 初学者は弓の元から先へ移動する際に接触力が弱まりやすく、自己評価が困難。
- 指導は経験と感覚に依存し客観性が不足。
- 力を定量化し可視化することで、理想と現状の差分を捉えた効率的練習が可能になる。

## 3. 用語定義

| 用語 | 定義 |
| --- | --- |
| 運弓 | バイオリン演奏時の弓の動作全体（ダウン/アップ） |
| ロードセル | 加わる力を電気信号へ変換する荷重センサ |
| 弓元 / 弓先 | 弓の持ち手側 / 先端側 |

## 4. システム全体像

[ロードセル]
│
[HX711（ADC）]
│（クロック & データ線）
[RP2040（マイコン）]
│（TinyUSB HID）
[USBケーブル]
│
[PCのChromeブラウザ]
│（WebHID API）
[JavaScript → WebGL/Canvas]
↓
画面にリアルタイム波形

- **通信I/F**：USB HID または BLE (BLE‑HID profile) に対応し、HID 64 byte パケットを 1 kHz で送信。
- **プロトコル**：固定長ヘッダ＋CRC16。エラー時は NACK 再送。

### 4.1 リアルタイムストリーム処理パイプライン

| 段階 | 処理内容 | ターゲット遅延 |
| --- | --- | --- |
| ① センサ取込 | MCU 16‑bit ADC → DMA バッファリング (32 samples) | <1 ms |
| ② パケット化 | USB HID/BLE HID 64 byte 送信 | <1 ms |
| ③ 受信 & バッファ | PC/WebSerial (RingBuffer 256 samples) | <5 ms |
| ④ フィルタ処理 | IIR ローパス (fc 100 Hz) on Worker Thread | <3 ms |
| ⑤ 描画 | WebGL/Canvas 60 fps レンダリング | <10 ms |
| **合計** |  | **< 20 ms (目標)** |

*50 ms 以下の非機能要求を十分に満たし、遅延をユーザが知覚しないレベルに抑える。*

### 4.2 データフォーマット

```
Byte 0   : 0xA5 (SOH)
Byte 1   : Packet ID (rolling)
Byte 2‑3 : Timestamp (µs / 250)
Byte 4‑5 : LoadCell_A (LSB first)
Byte 6‑7 : LoadCell_B
Byte 8‑9 : Temperature (optional)
Byte 10‑11 : CRC16‑CCITT
```

---

## 5. 機能要求. 機能要求

### 5.1 ハードウェア機能

1. **荷重測定**：0–10 N 範囲、分解能 0.05 N 以上。
2. **サンプリングレート**：≥ 1 kHz（音符分解能とリアルタイム表示確保）。
3. **装着性**：総重量 +20 g 以内、演奏バランスを損なわない。

### 5.2 ソフトウェア機能

1. **リアルタイム波形表示**：遅延 ≤ 50 ms。
2. **モデル比較表示**：指導者ベースラインのロードからのオーバーレイ。
3. **録画・再生**：演奏動画（任意）とセンサ波形を同期保存。
4. **分析レポート生成**：平均荷重、ばらつき、テンポ逸脱を自動計算。

### 5.3 非機能要求

- **安全性**：感電・破損防止、弓への加工最小。
- **拡張性**：追加センサ（加速度・角度）へ対応可能なI/F。
- **可搬性**：USB給電のみで動作。
- **保守性**：ファーム／アプリはOSSとして公開、単体アップデート可能。

## 6. ハード・ファームウェア構成

### 6.1 必要な部品リスト（初心者向け）

| 部品名 | 型番・仕様 | 数量 | 使いみち | 買うときのポイント |
| --- | --- | --- | --- | --- |
| 荷重センサー（ロードセル） | 薄型 S型 20N | 2 | 弓の持ち手側と先端側に取り付けて、弦を押す力を測る | 小さくて軽いもの。20Nくらいまで測れるタイプ |
| センサー用変換基板（HX711） | HX711（24ビット） | 2 | センサーの微妙な電気信号をパソコンで使えるデータに変換 | 1秒間に1000回測れるもの。Amazonなどで買える |
| 小型コンピュータ（マイコン） | Raspberry Pi Pico (RP2040) | 1 | センサーのデータをまとめてパソコンに送る | USBでパソコンにつなげる。家電量販店でも買える |
| 固定用パーツ | 3Dプリントクランプ | 1 | センサーを弓にしっかり固定する | 弓を傷つけない設計。取り外しできると便利 |
| USBケーブル | USB-Cケーブル 1m | 1 | コンピュータとパソコンをつなぐ | 長さは1mくらいが使いやすい |
| パソコン | Windows/Mac/Linux | 1 | データを表示・分析する | Chromeブラウザが必要 |

> ※荷重センサーは「S型ロードセル 20N」で検索。  
> ※HX711はAmazonなどで「ロードセル変換基板」として売っている。  
> ※Raspberry Pi Picoは家電量販店や通販で買える。  
> ※3Dプリントクランプは自作か外注。  
> ※USBケーブルは家電量販店でOK。

---

### 用語の説明（わかりやすく）

- **荷重センサー（ロードセル）**：弓が弦を押す力を測る部品
- **変換基板（HX711）**：センサーの細かい電気信号をパソコンで使えるデータにする部品
- **マイコン（Raspberry Pi Pico）**：センサーのデータをまとめてパソコンに送る小型コンピュータ
- **3Dプリントクランプ**：センサーを弓に固定するためのパーツ
- **USBケーブル**：データや電源をやりとりする線
- **パソコン**：データをグラフで表示したり分析する

---

### システムの流れ（ざっくり）

1. 弓に荷重センサーをつける
2. センサーの信号を変換基板でデータ化
3. マイコンがデータをまとめてUSBでパソコンに送る
4. パソコンでリアルタイムにグラフ表示

---

### 6.2 ファームウェアスタック

| 層 | ライブラリ / 技術 | 目的 |
| --- | --- | --- |
| USB デバイス | **TinyUSB** Device Stack | WebUSB HID / Vendor End‑point |
| ADC ドライバ | PIO + DMA | HX711 1 kSPS 読み取り |
| パケット層 | C Struct + CRC16 | 固定 64 B フレーム化 |
| RTOS / 言語 | Bare‑metal C++ (FreeRTOS optional) | タスク分離 (ADC / USB) |

### 6.3 PC / ブラウザスタック

| レイヤ | 技術 | 備考 |
| --- | --- | --- |
| デバイス API | **WebUSB** (Chrome/Edge 98+) | 接続ダイアログ付き |
| データ処理 | TypeScript + WebWorker + SharedArrayBuffer | GC 回避、IIR フィルタ |
| 描画 | React + **WebGL (regl)** | 60 fps 波形 / モデル比較 |

### 6.4 拡張オプション

- MCU を **ESP32‑S3** に置換 → Wi‑Fi + USB デュアルで将来クラウド転送対応
- USB → **WebSocket ブリッジ** (`serialport` + `ws`) を Node/Tauri 内部に実装し、複数端末同時視聴を実現

---

## 7. データフロー詳細. データフロー詳細

リアルタイム波形表示までのパイプラインを「信号→ビット→フレーム→オブジェクト→ピクセル」の 5 レイヤで整理する。

| レイヤ | No. | 処理ブロック | 主な役割 | データ形式 | レート/遅延目安 |
| --- | --- | --- | --- | --- | --- |
| **A. アナログ** | ① 弓ロードセル | 荷重を起電力へ変換 | mV/V | –– |  |
|  | ② 増幅 (HX711 PGA) | 微小電圧を 128× 増幅 | mV → V | <1 µs |  |
| **B. デジタイズ** | ③ ADC (24‑bit) | ロードセル×2 を交互サンプリング | Signed Int24 | 1 kS/s ×2 |  |
|  | ④ MCU DMA RingBuf | 32 samples バッファリング | Int24 Array | <1 ms |  |
| **C. パケット** | ⑤ Packetizer | ヘッダ＋CRC16 付与、HID 64 B へ分割 | Uint8[64] | ～1 kHz |  |
|  | ⑥ USB HID Tx | USB FullSpeed Isochronous | フレーム | <1 ms |  |
| **D. 転送・受信** | ⑦ WebHID API | ブラウザで受信、JS へデコード | Uint16[32] | <5 ms |  |
|  | ⑧ Worker RingBuf | SharedArrayBuffer 256 samples | Float32 | –– |  |
| **E. 表示** | ⑨ DSP Filter | IIR ローパス fc=100 Hz | Float32 | <3 ms |  |
|  | ⑩ Renderer (WebGL) | 波形を 60 fps で描画 | Vertices | <10 ms |  |
| **合計** |  |  |  |  |  |
|  | **目標遅延 : 20 ms 以下** |  |  |  |  |

### 7.1 シーケンス図（概念）

```
sequenceDiagram
  participant LC as Load Cell
  participant HX as HX711
  participant MCU as MCU/ADC
  participant USB as USB HID
  participant JS as WebHID Worker
  participant GL as WebGL Renderer

  LC->>HX: Analog mV/V
  HX->>MCU: Int24 (1 kHz)
  MCU->>USB: 64B HID Packet (CRC16)
  USB->>JS: Uint8[]
  JS->>JS: Decode & Filter
  JS->>GL: Float32[] (RingBuf Ptr)
  GL->>GL: Draw LineStrip (60 fps)
```

### 7.2 タイムライン例

- t = 0 ms: 弓元 4.35 N, 弓先 4.40 N を ADC 取得
- t = 1 ms: MCU に 2 点溜まり 64B パケット生成
- t = 2 ms: USB 到着。WebHID が JS Worker へ push
- t = 6 ms: 256 sample バッファ満杯直前、IIR 適用→描画キュー
- t = 16 ms: WebGL の次フレーム vsync → 1 px/1 sample 換算でライン更新
- t = 18 ms: ユーザが画面で荷重変化を視認

この通し遷移で **エンドツーエンド ≒18 ms** を見込む。

---

## 8. UI/UX 仕様（PCアプリ）. UI/UX 仕様（PCアプリ）

- メインビュー：リアルタイム荷重グラフ（弓元・弓先・合算）
- 比較モード：指導者モデルと半透明重ね合わせ
- メトロノーム同期：テンポ 40–200 BPM 切替
- 録画コントロール：REC/STOP, 解析レポート生成ボタン

## 9. キャリブレーション手順

1. 弓を軽く置いた状態を 0 N としてゼロ点補正。
2. 所定のおもり (e.g., 1 kgf) を吊下げ荷重係数を自動計算。
3. 温度ドリフト補正：5 分毎に 2 点補正実施。

## 10. テスト計画

| テストID | 目的 | 項目 | 基準 | 試験方法 |
| --- | --- | --- | --- | --- |
| HW‑01 | 測定精度 | 静的荷重誤差 | ±2 % F.S. | 校正おもり3段階 |
| SW‑03 | リアルタイム性 | 表示遅延 | ≤50 ms | オシロ＋スクリーン録画 |
| SYS‑05 | ユーザ試用 | 1時間演奏 | 故障なし | 実演による耐久 |

## 11. リスク / 安全対策

- ロードセル配線断線 → ストレインリリーフ追加
- 弓破損リスク → 着脱式クランプ設計、無加工対応
- プレイヤー接触事故 → ケーブル長1 m以内、足元配線禁止

## 12. 開発スケジュール（案）

| フェーズ | 期間 | 成果物 |
| --- | --- | --- |
| 要件定義 | 7/15–7/31 | 本設計書 ver1.0 |
| 試作 HW | 8/1–8/15 | 試作弓+回路 POC |
| 試作 SW | 8/1–8/31 | UI β版 |
| 統合評価 | 9/1–9/15 | 評価レポート |
| 量産設計 | 9/16–10/15 | 設計書 ver2.0、BOM |
| ユーザテスト | 10/16–10/31 | ユーザフィードバック |

## 13. 参考資料

- 小林「運弓上達補助装置」総論（2025‑07‑06）
- HX711 データシート
- バイオリン教育学研究誌 Vol.xx

---