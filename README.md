## 0. 改訂履歴

| 版 | 日付 | 作成者 | 概要 |
| --- | --- | --- | --- |
| 0.1 | 2025‑07‑15 | AI draft | 初版ドラフト作成 |

---

## 1. 目的 / Scope

バイオリンの弓運び（運弓）における弓と弦の接触力を数値化・可視化し、学習者が理想的な運弓を習得するためのフィードバックをリアルタイムに提供する装置の設計を行う。

## 2. 背景・課題

- 初学者は弓の元から先へ移動する際に接触力が弱まりやすく、自己評価が困難。
- 指導は経験と感覚に依存し客観性が不足。
- 力を定量化し可視化することで、理想と現状の差分を捉えた効率的練習が可能になる。

## 3. 用語定義

| 用語 | 定義 |
| --- | --- |
| 運弓 | バイオリン演奏時の弓の動作全体（ダウン/アップ） |
| ロードセル | 加わる力を電気信号へ変換する荷重センサ |
| 弓元 / 弓先 | 弓の持ち手側 / 先端側 |

## 4. システム全体像

[ロードセル]
│
[HX711（ADC）]
│（クロック & データ線）
[RP2040（マイコン）]
│（TinyUSB HID）
[USBケーブル]
│
[PCのChromeブラウザ]
│（WebHID API）
[JavaScript → WebGL/Canvas]
↓
画面にリアルタイム波形

- **通信I/F**：USB HID に対応し、HID 64 byte パケットを 1 kHz で送信。
- **プロトコル**：固定長ヘッダ＋CRC16。エラー時は NACK 再送。

---

## 5. ハード・ファームウェア構成

| 部品名                       | 型番・仕様             | 主な用途                           | 数量 | 購入目安・備考                       |
|------------------------------|------------------------|-------------------------------------|------|---------------------------------------|
| 荷重センサー（ロードセル）   | S型ロードセル 20N      | 弓元・弓先の力計測                  | 2    | 小型・軽量、20N程度まで測定可能      |
| センサー用変換基板（HX711）  | HX711（24ビット）      | ロードセル信号の増幅・ADC変換       | 2    | 1kHz対応、Amazon等で入手可能         |
| 小型コンピュータ（マイコン） | Raspberry Pi Pico      | センサーデータの集約・USB送信       | 1    | RP2040搭載、USB接続                  |
| 固定用パーツ                 | 3Dプリントクランプ     | センサーの弓への固定                | 1    | 弓を傷つけない設計                   |
| USBケーブル                  | USB-Cケーブル 1m       | マイコンとPCの接続                  | 1    | 長さ1m程度が使いやすい               |
| パソコン                     | Windows/Mac/Linux      | データ表示・分析                    | 1    | Chromeブラウザ必須                   |
| **バイオリン弓**             | 標準サイズ             | センサー取付・実験用                | 1    | 既存品または安価な練習用で可         |

> ※HX711は「ロードセル変換基板」として販売。  
> ※Raspberry Pi Picoは家電量販店や通販で入手可能。  
> ※3Dプリントクランプは自作または外注。  
> ※USBケーブルは家電量販店で購入可能。

---

### 用語の説明

- **荷重センサー（ロードセル）**：弓が弦を押す力を測る部品
- **変換基板（HX711）**：センサーの細かい電気信号をパソコンで使えるデータにする部品
- **マイコン（Raspberry Pi Pico）**：センサーのデータをまとめてパソコンに送る小型コンピュータ
- **3Dプリントクランプ**：センサーを弓に固定するためのパーツ
- **USBケーブル**：データや電源をやりとりする線
- **パソコン**：データをグラフで表示したり分析する

---

### システムの流れ

1. 弓に荷重センサーをつける
2. センサーの信号を変換基板でデータ化
3. マイコンがデータをまとめてUSBでパソコンに送る
4. パソコンでリアルタイムにグラフ表示

---

### ファームウェアスタック

| 層 | ライブラリ / 技術 | 目的 |
| --- | --- | --- |
| USB デバイス | **TinyUSB** Device Stack | WebUSB HID / Vendor End‑point |
| ADC ドライバ | PIO + DMA | HX711 1 kSPS 読み取り |
| パケット層 | C Struct + CRC16 | 固定 64 B フレーム化 |
| RTOS / 言語 | Bare‑metal C++ | タスク分離 (ADC / USB) |

---

### PC / ブラウザスタック

| レイヤ | 技術 | 備考 |
| --- | --- | --- |
| デバイス API | **WebUSB** (Chrome/Edge 98+) | 接続ダイアログ付き |
| データ処理 | TypeScript + WebWorker + SharedArrayBuffer | GC 回避、IIR フィルタ |
| 描画 | React + **WebGL (regl)** | 60 fps 波形表示 |

---

## 6. データフロー詳細

リアルタイム波形表示までのパイプラインを「信号→ビット→フレーム→オブジェクト→ピクセル」の 5 レイヤで整理する。

| レイヤ | No. | 処理ブロック | 主な役割 | データ形式 | レート/遅延目安 |
| --- | --- | --- | --- | --- | --- |
| **A. アナログ** | ① 弓ロードセル | 荷重を起電力へ変換 | mV/V | –– |  |
|  | ② 増幅 (HX711 PGA) | 微小電圧を 128× 増幅 | mV → V | <1 µs |  |
| **B. デジタイズ** | ③ ADC (24‑bit) | ロードセル×2 を交互サンプリング | Signed Int24 | 1 kS/s ×2 |  |
|  | ④ MCU DMA RingBuf | 32 samples バッファリング | Int24 Array | <1 ms |  |
| **C. パケット** | ⑤ Packetizer | ヘッダ＋CRC16 付与、HID 64 B へ分割 | Uint8[64] | ～1 kHz |  |
|  | ⑥ USB HID Tx | USB FullSpeed Isochronous | フレーム | <1 ms |  |
| **D. 転送・受信** | ⑦ WebHID API | ブラウザで受信、JS へデコード | Uint16[32] | <5 ms |  |
|  | ⑧ Worker RingBuf | SharedArrayBuffer 256 samples | Float32 | –– |  |
| **E. 表示** | ⑨ DSP Filter | IIR ローパス fc=100 Hz | Float32 | <3 ms |  |
|  | ⑩ Renderer (WebGL) | 波形を 60 fps で描画 | Vertices | <10 ms |  |
| **合計** |  |  |  |  |  |
|  | **目標遅延 : 20 ms 以下** |  |  |  |  |

---

### 使用言語

- **ファームウェア（マイコン側）**  
  - C / C++（Bare-metal）

- **PC・ブラウザ側**  
  - TypeScript（データ処理、WebWorker等）
  - JavaScript（WebHID API、WebGL描画）
  - React（UI構築）

---
